<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Level-Angle Calculator (3-Point Plane)</title>
  <style>
    :root { --bg:#0b1020; --panel:#111935; --muted:#93a0c3; --text:#e8edff; --acc:#7aa2ff; --bad:#ff6b6b; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(160deg,#0b1020,#0e1430 40%,#0b1020);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Apple Color Emoji,Segoe UI Emoji}
    .wrap{max-width:980px;margin:40px auto;padding:24px}
    .card{background:rgba(17,25,53,.9);border:1px solid rgba(122,162,255,.15);backdrop-filter: blur(6px);border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,.35)}
    header{padding:28px 28px 12px}
    header h1{margin:0;font-weight:800;letter-spacing:.3px;font-size:28px}
    header p{margin:8px 0 0;color:var(--muted)}
    .content{padding:0 24px 24px}
    .grid{display:grid;gap:16px}
    @media (min-width:860px){.grid-3{grid-template-columns:repeat(3,1fr)}}
    .panel{padding:16px;border:1px solid rgba(122,162,255,.12);border-radius:16px;background:rgba(12,18,40,.65)}
    .panel h3{margin:0 0 8px;font-size:14px;color:#c8d3ff;letter-spacing:.3px}
    label{display:block;font-size:12px;color:#c2cbef;margin:10px 0 6px}
    input{width:100%;padding:12px 12px;border-radius:12px;border:1px solid rgba(122,162,255,.22);background:#0b122a;color:var(--text);outline:none}
    input:focus{border-color:var(--acc);box-shadow:0 0 0 3px rgba(122,162,255,.15)}
    .row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
    button{cursor:pointer;border:1px solid rgba(122,162,255,.25);background:linear-gradient(180deg,#1b2550,#141c3e);color:var(--text);padding:12px 14px;border-radius:12px;font-weight:600}
    button.primary{border-color:#7aa2ff;background:linear-gradient(180deg,#3b5bff,#2a47c7)}
    button.ghost{background:transparent}
    button.warn{border-color:transparent;background:linear-gradient(180deg,#ff7b7b,#ff4a4a)}
    .result{margin-top:20px;padding:18px;border-radius:16px;border:1px dashed rgba(122,162,255,.3);background:rgba(10,16,36,.6)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .muted{color:var(--muted)}
    .err{color:var(--bad);font-weight:700}
    footer{padding:20px 28px;color:#8ea0d6;font-size:12px}
    .kbd{border:1px solid rgba(255,255,255,.2);padding:2px 6px;border-radius:6px;background:#0b122a}
  </style>
</head>
<body>
  <div class="wrap card">
    <header>
      <h1>Level-Angle Calculator (3‑Point Plane)</h1>
      <p>세 점 <span class="mono">p1, p2, p3</span> 를 입력하면, 평면의 법선을 구해 <b>X·Y 회전각</b>(수평화에 필요한 보정각)을 계산합니다. (우측 좌표계, <span class="mono">z</span>는 위쪽)</p>
    </header>
    <div class="content">
      <div class="grid grid-3">
        <div class="panel">
          <h3>p1</h3>
          <div class="row">
            <div><label>x</label><input id="p1x" type="number" step="any" value="-52131"></div>
            <div><label>y</label><input id="p1y" type="number" step="any" value="-54902"></div>
            <div><label>z</label><input id="p1z" type="number" step="any" value="-31704"></div>
          </div>
        </div>
        <div class="panel">
          <h3>p2</h3>
          <div class="row">
            <div><label>x</label><input id="p2x" type="number" step="any" value="-834"></div>
            <div><label>y</label><input id="p2y" type="number" step="any" value="-54902"></div>
            <div><label>z</label><input id="p2z" type="number" step="any" value="-30090"></div>
          </div>
        </div>
        <div class="panel">
          <h3>p3</h3>
          <div class="row">
            <div><label>x</label><input id="p3x" type="number" step="any" value="-834"></div>
            <div><label>y</label><input id="p3y" type="number" step="any" value="149"></div>
            <div><label>z</label><input id="p3z" type="number" step="any" value="-32356"></div>
          </div>
        </div>
      </div>

      <div class="btns">
        <button class="primary" id="calcBtn">각도 계산</button>
        <button class="ghost" id="sampleBtn">예시 좌표 불러오기</button>
        <button class="ghost" id="copyBtn">결과 복사</button>
        <button class="warn" id="resetBtn">초기화</button>
      </div>

      <div id="error" class="result" style="display:none"><span class="err">입력 오류</span> — 세 점이 서로 달라야 하고, <span class="mono">p1→p2</span>와 <span class="mono">p1→p3</span>이 같은 직선상에 놓이면 안 됩니다.</div>

      <div id="out" class="result" style="display:none"></div>

      <div class="muted" style="margin-top:14px">Tip: 결과의 보정각은 <span class="mono">X → Y</span> 순서 회전(롤→피치)을 가정합니다. 법선의 <span class="mono">z</span>성분이 음수면 자동으로 뒤집어(+z) 정규화합니다.</div>
    </div>
    <footer>
      단축키: <span class="kbd">Enter</span> 계산 · <span class="kbd">R</span> 초기화
    </footer>
  </div>

<script>
  function vecSub(a,b){return [a[0]-b[0],a[1]-b[1],a[2]-b[2]]}
  function cross(a,b){return [a[1]*b[2]-a[2]*b[1], a[2]*b[0]-a[0]*b[2], a[0]*b[1]-a[1]*b[0]]}
  function norm(a){return Math.hypot(a[0],a[1],a[2])}
  function scale(a,s){return [a[0]*s,a[1]*s,a[2]*s]}

  function levelAngles(p1,p2,p3){
    const u = vecSub(p2,p1);
    const v = vecSub(p3,p1);
    const n0 = cross(u,v);
    const m = norm(n0);
    if(!isFinite(m) || m===0) return {err:"colinear"};
    let n = scale(n0,1/m);
    if(n[2] < 0) n = scale(n,-1);
    const [nx,ny,nz] = n;
    const roll = Math.atan2(ny, nz);            // about X
    const pitch = -Math.atan2(nx, Math.hypot(ny, nz)); // about Y
    const thetaX = -roll;
    const thetaY = -pitch;
    return { n, thetaX, thetaY };
  }

  function readPoint(prefix){
    const x = parseFloat(document.getElementById(prefix+"x").value);
    const y = parseFloat(document.getElementById(prefix+"y").value);
    const z = parseFloat(document.getElementById(prefix+"z").value);
    return [x,y,z];
  }

  function fmtDeg(rad){ return (rad*180/Math.PI).toFixed(4); }
  function fmt(v){ return v.map(x=> x.toFixed(6)).join(", "); }

  function calculate(){
    const p1 = readPoint("p1");
    const p2 = readPoint("p2");
    const p3 = readPoint("p3");
    const out = document.getElementById('out');
    const err = document.getElementById('error');

    if(p1.some(isNaN) || p2.some(isNaN) || p3.some(isNaN)){
      err.style.display='block'; out.style.display='none'; return;
    }

    const res = levelAngles(p1,p2,p3);
    if(res.err){ err.style.display='block'; out.style.display='none'; return; }

    err.style.display='none';
    out.style.display='block';
    out.innerHTML = `
      <div><b>법선 벡터 n</b> = <span class="mono">(${fmt(res.n)})</span></div>
      <div style="margin-top:8px"><b>보정 회전각</b></div>
      <div class="mono">X축(roll): ${fmtDeg(res.thetaX)}°</div>
      <div class="mono">Y축(pitch): ${fmtDeg(res.thetaY)}°</div>
    `;
  }

  document.getElementById('calcBtn').addEventListener('click', calculate);
  document.getElementById('sampleBtn').addEventListener('click', () => {
    document.getElementById('p1x').value = -52131;
    document.getElementById('p1y').value = -54902;
    document.getElementById('p1z').value = -31704;
    document.getElementById('p2x').value = -834;
    document.getElementById('p2y').value = -54902;
    document.getElementById('p2z').value = -30090;
    document.getElementById('p3x').value = -834;
    document.getElementById('p3y').value = 149;
    document.getElementById('p3z').value = -32356;
    calculate();
  });
  document.getElementById('resetBtn').addEventListener('click', () => { location.reload(); });
  document.getElementById('copyBtn').addEventListener('click', () => {
    const out = document.getElementById('out');
    if(out.style.display==='none') return;
    const text = out.innerText.replaceAll('\n','\n');
    navigator.clipboard.writeText(text);
  });
  document.addEventListener('keydown', (e)=>{
    if(e.key==='Enter') calculate();
    if(e.key.toLowerCase()==='r') location.reload();
  });

  // 초기 자동 계산
  calculate();
</script>
</body>
</html>
